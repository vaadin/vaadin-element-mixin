<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-element-mixin tests</title>

  <script src="../../../wct-browser-legacy/browser.js"></script>
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>
  <script type="module" src="../vaadin-element-mixin.js"></script>
  <script type="module" src="../../../@polymer/polymer/polymer-element.js"></script>
  <script type="module" src="../../../@polymer/polymer/lib/utils/render-status.js"></script>
</head>

<body>
  <script type="module">
import { ElementMixin } from '../vaadin-element-mixin.js';
import { PolymerElement } from '@polymer/polymer/polymer-element.js';
import { afterNextRender } from '@polymer/polymer/lib/utils/render-status.js';
class TestElement extends ElementMixin(PolymerElement) {
  static get is() {
    return 'test-element';
  }
}
customElements.define(TestElement.is, TestElement);

describe('basic functionality', function() {
  const element = document.createElement('test-element');

  before(() => {
    document.body.appendChild(element);
  });

  beforeEach(() => {
    // Clean up the dir attribute
    document.documentElement.removeAttribute('dir');
    element.removeAttribute('dir');
  });

  function nextRender(element) {
    return new Promise(resolve => {
      afterNextRender(element, resolve);
    });
  }

  // Checks that for each `documentDirections` value set,
  // `testElement` dir attibute value equals to the correspondent value from `elementDirections`
  async function elementDirectionsAreCorrect(documentDirections, elementDirections, testElement) {
    for (let index = 0; index < documentDirections.length; index++) {
      setDir(documentDirections[index]);
      await nextRender(testElement);
      if (testElement.getAttribute('dir') !== elementDirections[index]) {
        return;
      }
    }
    return true;
  }

  // Setting or unsetting the document dir attribute value
  function setDir(direction) {
    if (direction) {
      document.documentElement.setAttribute('dir', direction);
    } else {
      document.documentElement.removeAttribute('dir');
    }
  }

  it('should propagate direction as dir attribute to the element from the documentElement', async() => {
    expect(await elementDirectionsAreCorrect(
      ['rtl', 'ltr', '', 'rtl', null],
      ['rtl', 'ltr', null, 'rtl', null],
      element
    )).to.be.true;
  });

  it('should preserve direction if was set by the user', async() => {
    element.setAttribute('dir', 'ltr');

    expect(await elementDirectionsAreCorrect(
      ['rtl', 'ltr', '', 'rtl', null],
      ['ltr', 'ltr', 'ltr', 'ltr', 'ltr'],
      element
    )).to.be.true;
  });

  it('should subscribe to the changes if set to equal the document direction', async() => {
    element.setAttribute('dir', 'ltr');

    expect(await elementDirectionsAreCorrect(
      ['rtl', 'ltr', 'rtl'],
      ['ltr', 'ltr', 'ltr'],
      element
    )).to.be.true;

    element.setAttribute('dir', 'rtl');

    expect(await elementDirectionsAreCorrect(
      ['ltr', 'rtl', ''],
      ['ltr', 'rtl', null],
      element
    )).to.be.true;
  });

  it('should subscribe to the changes if attribute removed', async() => {
    element.setAttribute('dir', 'ltr');

    expect(await elementDirectionsAreCorrect(
      ['rtl', 'ltr', 'rtl'],
      ['ltr', 'ltr', 'ltr'],
      element
    )).to.be.true;

    element.removeAttribute('dir');

    expect(await elementDirectionsAreCorrect(
      ['ltr', 'rtl', ''],
      ['ltr', 'rtl', null],
      element
    )).to.be.true;
  });

  it('should unsubscribe if attribute set by the user', async() => {
    expect(await elementDirectionsAreCorrect(
      ['rtl', 'ltr', 'rtl'],
      ['rtl', 'ltr', 'rtl'],
      element
    )).to.be.true;

    element.setAttribute('dir', 'ltr');

    expect(await elementDirectionsAreCorrect(
      ['ltr', 'rtl', ''],
      ['ltr', 'ltr', 'ltr'],
      element
    )).to.be.true;
  });

  it('should clean up the changes after unsubscribing', async() => {
    // Emulating overlay behaviour
    setDir('rtl');
    await nextRender(element);
    document.body.appendChild(element);
    setDir('ltr');
    await nextRender(element);
    expect(element.getAttribute('dir')).to.eql('ltr');
  });
});
</script>
</body>
